<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GB Remote Config Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"> <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"> <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="styles.css"> <!-- Custom CSS -->
    <style>
        /* Added rule for modal list item spacing */
        .modal-body ul li {
            margin-bottom: 0.6rem; /* Adjust this value as needed */
        }
        .modal-body ul {
            margin-bottom: 1rem; /* Add some space after the list */
        }
    </style>
</head>
<body>
    <!-- Twinkling Eyes for Dark Mode -->
    <div class="eyes-container">
        <div class="eye-pair" style="top: 15%; left: 10%; transform: rotate(-15deg);">
            <div class="eye">
                <div class="eyelid"></div>
            </div>
            <div class="eye">
                <div class="eyelid"></div>
            </div>
        </div>
        <div class="eye-pair" style="top: 10%; left: 85%; transform: rotate(20deg);">
            <div class="eye">
                <div class="eyelid"></div>
            </div>
            <div class="eye">
                <div class="eyelid"></div>
            </div>
        </div>
        <div class="eye-pair" style="top: 75%; left: 15%; transform: rotate(10deg);">
            <div class="eye">
                <div class="eyelid"></div>
            </div>
            <div class="eye">
                <div class="eyelid"></div>
            </div>
        </div>
        <div class="eye-pair" style="top: 80%; left: 80%; transform: rotate(-25deg);">
            <div class="eye">
                <div class="eyelid"></div>
            </div>
            <div class="eye">
                <div class="eyelid"></div>
            </div>
        </div>
        <div class="eye-pair" style="top: 45%; left: 50%; transform: rotate(5deg);">
            <div class="eye">
                <div class="eyelid"></div>
            </div>
            <div class="eye">
                <div class="eyelid"></div>
            </div>
        </div>
        <div class="eye-pair" style="top: 30%; left: 30%; transform: rotate(-10deg);">
            <div class="eye">
                <div class="eyelid"></div>
            </div>
            <div class="eye">
                <div class="eyelid"></div>
            </div>
        </div>
        <div class="eye-pair" style="top: 60%; left: 70%; transform: rotate(15deg);">
            <div class="eye">
                <div class="eyelid"></div>
            </div>
            <div class="eye">
                <div class="eyelid"></div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <header class="py-3 text-center">
            <h1 id="darkModeToggle" style="cursor:pointer;" title="Toggle dark mode">GB Remote Config Tool</h1>
        </header>

        <main>
            <div class="stepper-container"> <!-- Step navigation -->
                <div class="stepper">
                    <div class="stepper-item">
                        <div class="stepper-circle active" id="stepper1">1</div>
                        <div class="stepper-line"></div>
                    </div>
                    <div class="stepper-item">
                        <div class="stepper-circle" id="stepper2">2</div>
                        <div class="stepper-line"></div>
                    </div>
                    <div class="stepper-item">
                        <div class="stepper-circle" id="stepper3">3</div>
                        <div class="stepper-line"></div>
                    </div>
                    <div class="stepper-item">
                        <div class="stepper-circle" id="stepper4">4</div>
                    </div>
                </div>
                <div class="stepper-labels">
                    <div>Select Device</div>
                    <div>Connect</div>
                    <div>Configure</div>
                    <div>Flash</div>
                </div>
            </div>

            <div class="step-container active" id="step1"> <!-- Step 1: Select Device -->
                <h2>Select Your ESP32 Variant</h2>
                <p>Choose the ESP32 variant you want to flash</p>

                <div class="row device-cards">
                    <!-- ESP32-S3 -->
                    <div class="col-md-6 mb-4">
                        <div class="card device-card" data-device="ESP32-S3">
                            <div class="card-body text-center">
                                <h5 class="card-title device-name">ESP32-S3</h5>
                            </div>
                        </div>
                    </div>
                    <!-- ESP32-C3 -->
                    <div class="col-md-6 mb-4">
                        <div class="card device-card" data-device="ESP32-C3">
                            <div class="card-body text-center">
                                <h5 class="card-title device-name">ESP32-C3</h5>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button id="nextToStep2" class="btn btn-primary" disabled>
                        <i class="bi bi-arrow-right"></i> Continue
                    </button>
                </div>
            </div>

            <div class="step-container" id="step2"> <!-- Step 2: Connect -->
                <h2>Connect to <span id="selectedDeviceConnect"></span></h2>
                <p>Connect your device to your computer via USB and click the Connect button</p>

                <div class="card settings-card">
                    <div class="card-body">
                        <h5 class="card-title">Connection Settings</h5>

                        <div id="chipInfo">
                            <span class="status-indicator status-disconnected"></span> Disconnected
                        </div>

                        <div class="button-row mt-3">
                            <button id="connectButton" class="btn btn-primary">
                                <i class="bi bi-usb-symbol"></i> Connect
                            </button>
                            <button id="disconnectButton" class="btn btn-secondary" disabled>
                                <i class="bi bi-x-circle"></i> Disconnect
                            </button>
                        </div>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button id="backToStep1" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <button id="nextToStep3" class="btn btn-primary ms-2" disabled>
                        <i class="bi bi-arrow-right"></i> Continue
                    </button>
                </div>
            </div>

            <div class="step-container" id="step3"> <!-- Step 3: Configure -->
                <h2>Configure Firmware & Flash Settings</h2>
                <p>Choose how to provide the firmware.</p>

                <!-- Primary Choice: Download or Manual -->
                <div class="row firmware-choice-row">
                    <div class="col-md-6 mb-3">
                        <div class="card choice-card" id="choiceDownload">
                            <div class="card-body text-center">
                                <i class="bi bi-cloud-download choice-icon"></i>
                                <h5 class="card-title">Download Latest Firmware</h5>
                                <p class="card-text text-muted">Fetch the latest release directly from GitHub.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card choice-card" id="choiceManual">
                            <div class="card-body text-center">
                                <i class="bi bi-upload choice-icon"></i>
                                <h5 class="card-title">Upload Manually</h5>
                                <p class="card-text text-muted">Select .bin files from your computer.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Container for Download Options (Initially Hidden) -->
                <div id="downloadOptionsContainer" class="mb-3 d-none">
                    <div class="card">
                        <div class="card-body">
                            <div id="ghostEspDownloadSection" class="download-subsection">
                                <!-- Status Area for download/extract -->
                                <div id="ghostEspStatus" class="form-text text-muted mt-2" style="min-height: 1.5em;">
                                    Click "Download Latest Firmware" above to automatically download and extract firmware files.
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Container for Manual Upload (Initially Hidden) -->
                <div id="manualUploadContainer" class="mb-3 d-none">
                    <div id="manualUploadSection" class="card">
                        <div class="card-body">
                             <h5 class="card-title">Manual Upload</h5>
                            <div class="binary-type-toggle">
                                <button class="btn active" data-binary="app">
                                    <i class="bi bi-file-earmark-binary"></i> Application
                                </button>
                                <button class="btn" data-binary="bootloader">
                                    <i class="bi bi-hdd-network"></i> Bootloader
                                </button>
                                <button class="btn" data-binary="partition">
                                    <i class="bi bi-table"></i> Partition Table
                                </button>
                            </div>

                            <div id="appFirmware">
                                <div class="firmware-upload">
                                    <div class="mb-3">
                                        <label for="appAddress" class="form-label">App Address</label>
                                        <input type="text" class="form-control" id="appAddress" value="0x10000">
                                    </div>
                                    <label for="appFile" class="custom-file-upload">
                                        <span><i class="bi bi-upload"></i> Upload App Binary</span>
                                    </label>
                                    <input type="file" id="appFile" accept=".bin">
                                    <p id="appFileInfo" class="file-info">No file selected</p>
                                </div>
                            </div>

                            <div id="bootloaderFirmware" class="d-none">
                                <div class="firmware-upload">
                                    <div class="mb-3">
                                        <label for="bootloaderAddress" class="form-label">Bootloader Address</label>
                                        <input type="text" class="form-control" id="bootloaderAddress" value="0x1000">
                                    </div>
                                    <label for="bootloaderFile" class="custom-file-upload">
                                        <span><i class="bi bi-upload"></i> Upload Bootloader Binary</span>
                                    </label>
                                    <input type="file" id="bootloaderFile" accept=".bin">
                                    <p id="bootloaderFileInfo" class="file-info">No file selected</p>
                                </div>
                            </div>

                            <div id="partitionFirmware" class="d-none">
                                <div class="firmware-upload">
                                    <div class="mb-3">
                                        <label for="partitionAddress" class="form-label">Partition Address</label>
                                        <input type="text" class="form-control" id="partitionAddress" value="0x8000">
                                    </div>
                                    <label for="partitionFile" class="custom-file-upload">
                                        <span><i class="bi bi-upload"></i> Upload Partition Binary</span>
                                    </label>
                                    <input type="file" id="partitionFile" accept=".bin">
                                    <p id="partitionFileInfo" class="file-info">No file selected</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card settings-card mt-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-0">
                            <h5 class="card-title mb-0">Flash Options</h5>
                            <button class="btn btn-sm btn-outline-secondary" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#flashOptionsCollapse"
                                    aria-expanded="false" aria-controls="flashOptionsCollapse">
                                <i class="bi bi-gear"></i> Show Options
                            </button>
                        </div>

                        <div class="collapse mt-3" id="flashOptionsCollapse">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="flashMode" class="form-label">Flash Mode</label>
                                    <select id="flashMode" class="form-select">
                                        <option value="qio">QIO</option>
                                        <option selected value="dio">DIO</option>
                                        <option value="dout">DOUT</option>
                                        <option value="qout">QOUT</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="flashFreq" class="form-label">Flash Freq</label>
                                    <select id="flashFreq" class="form-select">
                                        <option value="20m">20 MHz</option>
                                        <option selected value="40m">40 MHz</option>
                                        <option value="80m">80 MHz</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="flashSize" class="form-label">Flash Size</label>
                                    <select id="flashSize" class="form-select">
                                        <option value="1MB">1 MB</option>
                                        <option value="2MB">2 MB</option>
                                        <option selected value="4MB">4 MB</option>
                                        <option value="8MB">8 MB</option>
                                        <option value="16MB">16 MB</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="eraseAll" checked>
                                <label class="form-check-label" for="eraseAll">
                                    Erase all flash before programming
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="preserveRemoteSettings" checked>
                                <label class="form-check-label" for="preserveRemoteSettings">
                                    Preserve Remote Settings (NVS & SPIFFS)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button id="backToStep2" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <button id="nextToStep4" class="btn btn-primary ms-2">
                        <i class="bi bi-arrow-right"></i> Continue
                    </button>
                </div>
            </div>

            <div class="step-container" id="step4"> <!-- Step 4: Flash -->
                <h2>Flash Your Device</h2>
                <p>Ready to flash your device with the selected firmware</p>

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Flash Summary</h5>
                        <ul id="flashSummary">
                            <!-- Flash summary will be populated by JS -->
                        </ul>

                        <div class="progress mb-1"> <!-- Reduced margin-bottom -->
                            <div id="flashProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-end mb-3"> <!-- Container for ETA -->
                            <small id="flashETA" class="text-muted"></small>
                        </div>

                        <div class="action-buttons">
                            <button id="eraseButton" class="btn btn-warning">
                                <i class="bi bi-trash"></i> Erase Flash
                            </button>
                            <button id="flashButton" class="btn btn-success">
                                <i class="bi bi-lightning"></i> Flash Firmware
                            </button>
                        </div>
                    </div>
                </div>

                <div id="globalStatusIndicator" class="alert alert-warning d-none mt-3" role="alert"></div>

                <div class="navigation-buttons">
                    <button id="backToStep3" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <button id="startOver" class="btn btn-outline-primary ms-2">
                        <i class="bi bi-arrow-repeat"></i> Start Over
                    </button>
                </div>
            </div>

            <div class="mt-4 terminal-section"> <!-- Terminal output -->
                <div class="terminal-header">
                    <h5><i class="bi bi-terminal"></i> Output Log</h5>
                </div>
                <pre id="terminal"></pre>
            </div>
        </main>

        <footer class="py-3 text-center">
        </footer>
    </div>

    <!-- Scripts -->

    <script type="module">
        import * as esptoolJS from 'https://fragrant-flower-ba0b.creepersbeast.workers.dev/?url=https%3A%2F%2Fraw.githubusercontent.com%2Fjaylikesbunda%2FESPressoFlash%2Fmain%2Fbundle.js';
        window.esptoolJS = esptoolJS;
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

    <!-- Flasher Logic -->
    <script src="flasher.js"></script>

    <!-- Custom JS (if any depends on flasher.js, keep it after) -->
    <script src="custom.js"></script>

</body>
</html>